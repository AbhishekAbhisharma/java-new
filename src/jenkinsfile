pipeline {
  agent any
  environment {
    IMAGE_NAME = "node-sample-app"
    IMAGE_TAG  = "${env.BUILD_NUMBER}"
    ART_REG    = "artifactory:5000"   // replace if different
    SONAR_HOST = "http://sonarqube:9000"
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Install & Test (with coverage)') {
      steps {
        sh 'npm ci'
        sh 'npm run coverage'   // generates coverage/lcov.info
        junit '**/coverage/**'  // jest won't generate JUnit by default; optional
      }
      post {
        always { archiveArtifacts artifacts: 'coverage/**', allowEmptyArchive: true }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
          sh """
            docker run --rm -v \$(pwd):/usr/src -w /usr/src sonarsource/sonar-scanner-cli \
              -Dsonar.projectKey=node-sample-app \
              -Dsonar.sources=. \
              -Dsonar.host.url=${SONAR_HOST} \
              -Dsonar.login=${SONAR_TOKEN} \
              -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
          """
        }
      }
    }

    stage('Wait for Quality Gate') {
      steps {
        timeout(time: 5, unit: 'MINUTES') {
          script {
            def qg = waitForQualityGate()
            if (qg.status != 'OK') { error "Quality Gate failed: ${qg.status}" }
          }
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
      }
    }

    stage('Trivy Scan') {
      steps {
        sh "docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image --severity HIGH,CRITICAL --exit-code 1 ${IMAGE_NAME}:${IMAGE_TAG}"
      }
    }

    stage('Push to Artifactory') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'artifactory-creds', usernameVariable: 'ART_USER', passwordVariable: 'ART_PASS')]) {
          sh """
            docker login -u ${ART_USER} -p ${ART_PASS} ${ART_REG}
            docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${ART_REG}/local-docker/${IMAGE_NAME}:${IMAGE_TAG}
            docker push ${ART_REG}/local-docker/${IMAGE_NAME}:${IMAGE_TAG}
          """
        }
      }
    }

    stage('Deploy') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'artifactory-creds', usernameVariable: 'ART_USER', passwordVariable: 'ART_PASS')]) {
          sh """
            docker login -u ${ART_USER} -p ${ART_PASS} ${ART_REG}
            docker rm -f ${IMAGE_NAME} || true
            docker run -d --name ${IMAGE_NAME} -p 3000:3000 ${ART_REG}/local-docker/${IMAGE_NAME}:${IMAGE_TAG}
          """
        }
      }
    }
  }
  post {
    always {
      echo "Pipeline finished"
    }
  }
}

